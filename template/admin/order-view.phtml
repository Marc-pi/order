<?php
$this->css(array(
    $this->assetModule('css/admin.css'),
    $this->assetModule('script/system-ui.css', 'system'),
));
$this->jQuery();
$this->backbone();
?>
<div id="js-order" class="clearfix">
    <div class="order-form" data-id="<?php echo $this->escape($order['id']); ?>"
         data-order="<?php echo $this->escape($order['url_update_order']); ?>"
         data-payment="<?php echo $this->escape($order['url_update_payment']); ?>"
         data-delivery="<?php echo $this->escape($order['url_update_delivery']); ?>">
        <h3><?php echo sprintf(__('Order %s details'), $order['code']); ?></h3>

        <div class="well">
            <h3><?php _e('Information'); ?></h3>

            <div class="clearfix">
                <div class="col-md-6">
                    <?php if (!empty($order['first_name']) && !empty($order['last_name'])) { ?>
                        <p><strong><?php _e('Name'); ?></strong> :
                            <span><?php echo $this->escape($order['first_name']); ?><?php echo $this->escape($order['last_name']); ?></span>
                        </p>
                    <?php } ?>
                    <?php if (!empty($order['id_number'])) { ?>
                        <p><strong><?php _e('ID number'); ?></strong> :
                            <span><?php echo $this->escape($order['id_number']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['address1'])) { ?>
                        <p><strong><?php _e('Address 1'); ?></strong> :
                            <span><?php echo $this->escape($order['address1']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['address2'])) { ?>
                        <p><strong><?php _e('Address 2'); ?></strong> :
                            <span><?php echo $this->escape($order['address2']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['city'])) { ?>
                        <p><strong><?php _e('City'); ?></strong> :
                            <span><?php echo $this->escape($order['city']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['state'])) { ?>
                        <p><strong><?php _e('State'); ?></strong> :
                            <span><?php echo $this->escape($order['state']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['country'])) { ?>
                        <p><strong><?php _e('Country'); ?></strong> :
                            <span><?php echo $this->escape($order['country']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['zip'])) { ?>
                        <p><strong><?php _e('Zip code'); ?></strong> :
                            <span><?php echo $this->escape($order['zip']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['email'])) { ?>
                        <p><strong><?php _e('Email'); ?></strong> :
                            <span><?php echo $this->escape($order['email']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['phone'])) { ?>
                        <p><strong><?php _e('Phone'); ?></strong> :
                            <span><?php echo $this->escape($order['phone']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['mobile'])) { ?>
                        <p><strong><?php _e('Mobile'); ?></strong> :
                            <span><?php echo $this->escape($order['mobile']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['company'])) { ?>
                        <p><strong><?php _e('Company'); ?></strong> :
                            <span><?php echo $this->escape($order['company']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['company_id'])) { ?>
                        <p><strong><?php _e('Company ID'); ?></strong> :
                            <span><?php echo $this->escape($order['company_id']); ?></span></p>
                    <?php } ?>
                    <?php if (!empty($order['company_vat'])) { ?>
                        <p><strong><?php _e('Company VAT'); ?></strong> :
                            <span><?php echo $this->escape($order['company_vat']); ?></span></p>
                    <?php } ?>
                </div>
                <div class="col-md-6">
                    <p><strong><?php _e('Order status'); ?></strong> :
                        <span><?php echo $this->escape($order['orderTitle']); ?> </span></p>

                    <p><strong><?php _e('Payment status'); ?></strong> :
                        <span><?php echo $this->escape($order['paymentTitle']); ?> </span></p>

                    <p><strong><?php _e('Delivery status'); ?></strong> :
                        <span><?php echo $this->escape($order['deliveryTitle']); ?> </span></p>

                    <p><strong><?php _e('Time create'); ?></strong> :
                        <span><?php echo $this->escape($order['time_create_view']); ?> </span></p>

                    <p><strong><?php _e('Time payment'); ?></strong> :
                        <span><?php echo $this->escape($order['time_payment_view']); ?> </span></p>

                    <p><strong><?php _e('Time delivery'); ?></strong> :
                        <span><?php echo $this->escape($order['time_delivery_view']); ?> </span></p>

                    <p><strong><?php _e('Time finish'); ?></strong> :
                        <span><?php echo $this->escape($order['time_finish_view']); ?> </span></p>

                    <p><strong><?php _e('Time start'); ?></strong> :
                        <span><?php echo $this->escape($order['time_start_view']); ?> </span></p>

                    <p><strong><?php _e('Time end'); ?></strong> :
                        <span><?php echo $this->escape($order['time_end_view']); ?> </span></p>

                    <p><strong><?php _e('Gateway'); ?></strong> :
                        <span><?php echo $this->escape($order['gateway']); ?> </span></p>
                    <?php if ($order['product_price'] > 0) { ?>
                        <p><strong><?php _e('Product price'); ?></strong> :
                            <span><?php echo $this->escape($order['product_price_view']); ?></span></p>
                    <?php } ?>
                    <?php if ($order['shipping_price'] > 0) { ?>
                        <p><strong><?php _e('Shipping price'); ?></strong> :
                            <span><?php echo $this->escape($order['shipping_price_view']); ?></span></p>
                    <?php } ?>
                    <?php if ($order['packing_price'] > 0) { ?>
                        <p><strong><?php _e('Packing price'); ?></strong> :
                            <span><?php echo $this->escape($order['packing_price_view']); ?></span></p>
                    <?php } ?>
                    <?php if ($order['vat_price'] > 0) { ?>
                        <p><strong><?php _e('Vat price'); ?></strong> :
                            <span><?php echo $this->escape($order['vat_price_view']); ?></span></p>
                    <?php } ?>
                    <?php if ($order['total_price'] > 0) { ?>
                        <p><strong><?php _e('Total price'); ?></strong> :
                            <span><?php echo $this->escape($order['total_price_view']); ?></span></p>
                    <?php } ?>
                    <?php if ($order['paid_price'] > 0) { ?>
                        <p><strong><?php _e('Paid price'); ?></strong> :
                            <span><?php echo $this->escape($order['paid_price_view']); ?></span></p>
                    <?php } ?>
                </div>
                <?php if (!empty($order['user_note'])) { ?>
                    <div class="col-md-12">
                        <strong><?php _e('User note'); ?></strong> : <?php echo $this->escape($order['user_note']); ?>
                    </div>
                <?php } ?>
            </div>
        </div>
        <div class="well">
            <h3><?php _e('User'); ?></h3>
            <ul class="clearfix list-unstyled">
                <li class="col-md-3"><strong><?php _e('ID'); ?></strong>
                    : <?php echo $this->escape($order['user']['id']); ?></li>
                <li class="col-md-3"><strong><?php _e('Email'); ?></strong>
                    : <?php echo $this->escape($order['user']['email']); ?></li>
                <li class="col-md-3"><strong><?php _e('Identity'); ?></strong>
                    : <?php echo $this->escape($order['user']['identity']); ?></li>
                <li class="col-md-3"><strong><?php _e('Name'); ?></strong>
                    : <?php echo $this->escape($order['user']['name']); ?></li>
            </ul>
        </div>
        <div class="well">
            <h3><?php _e('Order'); ?></h3>
            <ul class="clearfix list-unstyled">
                <li class="col-md-4"><strong><?php _e('Status'); ?></strong> : <span
                        id="update-order-<?php echo $this->escape($order['id']); ?>"
                        class="update-order btn <?php echo $this->escape($order['orderClass']); ?> "><?php echo $this->escape($order['orderTitle']); ?></span>
                </li>
                <li class="col-md-4"><strong><?php _e('Time'); ?></strong>
                    : <?php echo $this->escape($order['time_create_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Finish'); ?></strong> : <span
                        id="update-order-<?php echo $this->escape($order['id']); ?>-time"><?php echo $this->escape($order['time_finish_view']); ?></span>
                </li>
            </ul>
        </div>
        <div class="well">
            <h3><?php _e('Payment'); ?></h3>
            <ul class="clearfix list-unstyled">
                <li class="col-md-4"><strong><?php _e('Status'); ?></strong> : <span
                        id="update-payment-<?php echo $this->escape($order['id']); ?>"
                        class="update-payment btn <?php echo $this->escape($order['paymentClass']); ?> "><?php echo $this->escape($order['paymentTitle']); ?></span>
                </li>
                <li class="col-md-4"><strong><?php _e('Time'); ?></strong>
                    : <?php echo $this->escape($order['time_payment_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Adapter'); ?></strong> : <span
                        id="update-payment-<?php echo $this->escape($order['id']); ?>-adapter"><?php echo $this->escape($order['gateway']); ?></span>
                </li>
            </ul>
        </div>
        <div class="well">
            <h3><?php _e('Delivery'); ?></h3>
            <ul class="clearfix list-unstyled">
                <li class="col-md-3"><strong><?php _e('Status'); ?></strong> : <span
                        id="update-delivery-<?php echo $this->escape($order['id']); ?>"
                        class="update-delivery btn <?php echo $this->escape($order['deliveryClass']); ?> "><?php echo $this->escape($order['deliveryTitle']); ?></span>
                </li>
                <li class="col-md-3"><strong><?php _e('Time'); ?></strong> : <span
                        id="update-delivery-<?php echo $this->escape($order['id']); ?>-time"><?php echo $this->escape($order['time_delivery_view']); ?></span>
                </li>
                <li class="col-md-3"><strong><?php _e('Method'); ?></strong> :</li>
                <li class="col-md-3"><strong><?php _e('Packing'); ?></strong> :</li>
            </ul>
        </div>
        <div class="well">
            <h3><?php _e('Price'); ?></h3>
            <ul class="clearfix list-unstyled">
                <li class="col-md-4"><strong><?php _e('Price'); ?></strong>
                    : <?php echo $this->escape($order['product_price_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Discount'); ?></strong>
                    : <?php echo $this->escape($order['discount_price_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Shipping'); ?></strong>
                    : <?php echo $this->escape($order['shipping_price_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Packing'); ?></strong>
                    : <?php echo $this->escape($order['packing_price_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Total'); ?></strong>
                    : <?php echo $this->escape($order['total_price_view']); ?></li>
                <li class="col-md-4"><strong><?php _e('Paid'); ?></strong>
                    : <?php echo $this->escape($order['paid_price_view']); ?></li>
                <?php if ($order['type_payment'] == 'installment') { ?>
                    <li class="col-md-4"><strong><?php _e('Installment numbers'); ?></strong>
                        : <?php echo _number(count($order['invoices']) - 1); ?></li>
                <?php } ?>
            </ul>
        </div>
        <h3><?php _e('This order products or services list'); ?></h3>
        <table class="table table-striped table-bordered table-condensed">
            <tr>
                <th><?php _e('Product'); ?></th>
                <th><?php _e('Number'); ?></th>
                <th><?php _e('Price'); ?></th>
                <th><?php _e('Shipping'); ?></th>
                <th><?php _e('Packing'); ?></th>
                <th><?php _e('Vat'); ?></th>
                <th><?php _e('Total'); ?></th>
            </tr>
            <?php foreach ($order['products'] as $product) { ?>
                <tr>
                    <td>
                        <div class="productItem">
                            <a title="<?php echo $this->escape($product['details']['title']); ?>"
                               href="<?php echo $this->escape($product['details']['productUrl']); ?>">
                                <?php if (isset($product['details']['thumbUrl']) && !empty($product['details']['thumbUrl'])) { ?>
                                    <img width="32" height="32"
                                         src="<?php echo $this->escape($product['details']['thumbUrl']); ?>"
                                         alt="<?php echo $this->escape($product['details']['title']); ?>">
                                <?php } ?>
                                <?php echo $this->escape($product['details']['title']); ?>
                            </a>
                        </div>
                        <?php if (isset($product['extra']['product']) && !empty($product['extra']['product'])) { ?>
                            <?php foreach ($product['extra']['product'] as $extraProduct) { ?>
                                <div class="productItem">
                                    <span><?php echo $this->escape($extraProduct['title']); ?></span> :
                                    <strong><?php echo $this->escape($extraProduct['value']); ?></strong>
                                </div>
                            <?php } ?>
                        <?php } ?>
                    </td>
                    <td><?php echo _number($this->escape($product['number'])); ?></td>
                    <td><?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['product_price'])); ?></td>
                    <td><?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['shipping_price'])); ?></td>
                    <td><?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['packing_price'])); ?></td>
                    <td><?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['vat_price'])); ?></td>
                    <td><?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['total_price'])); ?></td>
                </tr>
            <?php } ?>
        </table>
        <?php if (!empty($order['invoices'])) { ?>
            <h3><?php _e('This order invoices list'); ?></h3>
            <table class="table table-striped table-bordered table-condensed">
                <tr>
                    <th><?php _e('ID'); ?></th>
                    <th><?php _e('Price'); ?></th>
                    <th><?php _e('Time Create'); ?></th>
                    <th><?php _e('Due date'); ?></th>
                    <th><?php _e('Time pay'); ?></th>
                    <th><?php _e('Action'); ?></th>
                </tr>
                <?php foreach ($order['invoices'] as $invoice) { ?>
                    <?php
                    if ($invoice['status'] == 1) {
                        $labelIdClass = 'label-success';
                    } elseif ($invoice['status'] == 2) {
                        $labelIdClass = 'label-warning';
                    } elseif ($invoice['status'] == 3) {
                        $labelIdClass = 'label-danger';
                    }
                    // Set row class
                    $rowClass = '';
                    if ($invoice['status'] == 1) {
                        $rowClass = ' class="success"';
                    } elseif ($invoice['time_duedate'] < strtotime("-1 day")) {
                        $rowClass = ' class="danger"';
                    } elseif ($invoice['time_duedate'] < strtotime("+1 day")) {
                        $rowClass = ' class="warning"';
                    }
                    ?>
                    <tr<?php echo $rowClass; ?>>
                        <td><span
                                class="label <?php echo $labelIdClass; ?>"><?php echo $this->escape($invoice['code']); ?></span>
                        </td>
                        <td><?php echo $this->escape($invoice['total_price_view']); ?></td>
                        <td><?php echo $this->escape($invoice['time_create_view']); ?></td>
                        <td><?php echo $this->escape($invoice['time_duedate_view']); ?></td>
                        <td><?php echo $this->escape($invoice['time_payment_view']); ?></td>
                        <td>
                            <a class="btn btn-primary" title="<?php _e('View'); ?>"
                               href="<?php echo $this->url('', array('controller' => 'invoice', 'action' => 'view', 'id' => $invoice['id'])); ?>"
                               target="_blank"><i class="fa fa-eye"></i> <?php _e('View'); ?></a>
                            <a class="btn btn-primary" title="<?php _e('Print'); ?>"
                               href="<?php echo $this->url('', array('controller' => 'invoice', 'action' => 'print', 'id' => $invoice['id'])); ?>"
                               target="_blank"><i class="fa fa-print"></i> <?php _e('Print'); ?></a>
                        </td>
                    </tr>
                <?php } ?>
            </table>
            <p>
                <span class="label label-success"><?php _e('Paid'); ?></span>
                <span class="label label-warning"><?php _e('Unpaid'); ?></span>
                <span class="label label-danger"><?php _e('Canceled'); ?></span>
            </p>
        <?php } ?>
        <div class="well">
            <h3><?php _e('Add extra invoice to this order'); ?></h3>
            <p><?php _e('If you want your user pay new price for this order, you can add new invoice for him by new price, use below button to add new invoice'); ?></p>
            <p><a class="btn btn-success"
                  href="<?php echo $this->url('', array('controller' => 'invoice', 'action' => 'update', 'order' => $order['id'])); ?>"
                  title="<?php _e('New invoice'); ?>" target="_blank"><i
                        class="fa fa-plus"></i> <?php _e('New invoice'); ?></a></p>
        </div>
    </div>
    <?php if ($order['type_payment'] == 'installment') { ?>
        <div class="clearfix">
            <div class="col-md-12 text-right">
                <a class="btn btn-success btn-lg" title="<?php _e('Print'); ?>"
                   href="<?php echo $this->url('', array('controller' => 'order', 'action' => 'print', 'id' => $order['id'])); ?>"><i
                        class="fa fa-print"></i> <?php _e('Print'); ?></a>
            </div>
        </div>
    <?php } ?>
</div>
<script>
    (function ($) {
        var page = {
            el: $('#js-order'),
            modal: $('<div class="modal fade">').appendTo(document.body),
            $: function (selector) {
                return this.el.find(selector);
            },
            init: function () {
                _.bindAll(this);
                this.$('.update-order').click(this.orderAction);
                this.$('.update-payment').click(this.paymentAction);
                this.$('.update-delivery').click(this.deliveryAction);
            },
            orderAction: function (e) {
                var p = $(e.target).parents('div.order-form'),
                    self = this;
                $.get(p.attr('data-order')).done(function (res) {
                    self.modal.html(res).modal('show');
                    formModule.success = function (res) {
                        var d = res.data;
                        self.modal.html(res).modal('hide');
                        $('#update-order-' + p.attr('data-id')).attr('class', 'update-order btn ' + d.orderClass).html(d.orderTitle);
                        $('#update-order-' + p.attr('data-id') + '-time').html(d.time_finish_view);
                    };
                });
            },
            paymentAction: function (e) {
                var p = $(e.target).parents('div.order-form'),
                    self = this;
                $.get(p.attr('data-payment')).done(function (res) {
                    self.modal.html(res).modal('show');
                    formModule.success = function (res) {
                        var d = res.data;
                        self.modal.html(res).modal('hide');
                        $('#update-payment-' + p.attr('data-id')).attr('class', 'update-payment btn ' + d.paymentClass).html(d.paymentTitle);
                        $('#update-payment-' + p.attr('data-id') + '-adapter').html(d.payment_adapter);
                        $('#update-payment-' + p.attr('data-id') + '-method').html(d.payment_method);
                        $('#update-payment-' + p.attr('data-id') + '-time').html(d.time_payment_view);
                    };
                });
            },
            deliveryAction: function (e) {
                var p = $(e.target).parents('div.order-form'),
                    self = this;
                $.get(p.attr('data-delivery')).done(function (res) {
                    self.modal.html(res).modal('show');
                    formModule.success = function (res) {
                        var d = res.data;
                        self.modal.html(res).modal('hide');
                        $('#update-delivery-' + p.attr('data-id')).attr('class', 'update-delivery btn ' + d.deliveryClass).html(d.deliveryTitle);
                        $('#update-delivery-' + p.attr('data-id') + '-time').html(d.time_delivery_view);
                    };
                });
            },
        }
        page.init();
    })(jQuery)
</script>