<?php
$this->css(array(
    $this->assetModule('css/front.css'),
    $this->assetModule('script/system-ui.css', 'system'),
));
$this->jQuery();
$this->backbone();
$script = <<<'EOT'
(function($) {
    var page = {
        el: $('#js-order'),
        $: function(selector) {
            return this.el.find(selector);
        },
        init: function() {
            _.bindAll(this);
            this.$('#select-location').on("change",this.locationAction);
            this.$('#select-delivery').on("change",this.deliveryAction);
            this.$('#select-payment').on("change",this.paymentAction);
            this.$('.showCustomerFrom').on("click",this.makeOrderAction);
            this.$('.showNewCustomerFrom').on("click",this.newAddressAction);
            this.$('#customerFromButtonNew').on("click",this.showNewAddress);
        },
        showNewAddress: function(e) {
            $('#customerFromNew').removeClass('hidden');
        },
        locationAction: function(e) {
            var url = "%s";
            $.getJSON(url + $('#select-location').val()).done(function(result) {
                if (result.status == 1) {
                    var htmlOptins = '';
                    $.each(result.data, function( index, value ) {
                        if (value.status==1) {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.delivery + "'>"
                                + value.title + " - "
                                + " %s " + value.price + " - "
                                + " %s " + value.delivery_time  + " %s "
                                + "</option>";
                        } else {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.delivery + "'>" + value.title + "</option>";
                        }
                    });
                    $('#select-delivery').html(htmlOptins);
                }
                $('#cart-location').html(result.location);
            });
        },
        deliveryAction: function(e) {
            var url = "%s";
            $.getJSON(url + $('#select-delivery').val()).done(function(result) {
                if (result.status == 1) {
                    $('#cart-total-shipping').html(result.data.shipping);
                    $('#cart-total-total').html(result.data.total);
                    var htmlOptins = '';
                    $.each(result.data.payment, function( index, value ) {
                        if (value.status==1) {
                            htmlOptins = htmlOptins
                                + "<option value='" + value.path + "'>"  + value.title + "</option>";
                        }
                    });
                    $('#select-payment').html(htmlOptins);
                }
                $('#cart-delivery').html(result.delivery);
                $('#cart-payment').html(result.payment);
            });
        },
        paymentAction: function(e) {
            var url = "%s";
            $.getJSON(url + $('#select-payment').val()).done(function(result) {
                if (result.status == 1) {
                    $('#cart-location').html(result.data.location);
                    $('#cart-delivery').html(result.data.delivery);
                    $('#cart-payment').html(result.data.payment);
                }
            });
        },
        makeOrderAction: function (e) {
            
            e.preventDefault();
            
            $('#customerFromNew').addClass('hidden');
            
            var idCustomer = $(e.target).attr('rel');
            $('form#order [name=customer_id]').val(idCustomer);
            $('form#order [name=submit_order_simple]').removeClass('hidden');
            
            $('.selected-address').addClass('hidden');
            $('.showCustomerFrom').addClass('inverse');
            $('.showCustomerFrom').removeClass('hidden');
            
            $(e.target).addClass('hidden');
            $(e.target).parent().parent().find('.selected-address').removeClass('hidden');
        },
        newAddressAction: function (e) {
            $('#customerFromNew').removeClass('hidden');
        },
        
    }
    page.init();
})(jQuery)
EOT;
$script = sprintf(
    $script,
    Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'level', 'process' => 'location', 'id' => ''))),
    __('Price : '),
    __('Time : '),
    __('Days'),
    Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'level', 'process' => 'delivery', 'id' => ''))),
    Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'level', 'process' => 'payment', 'id' => '')))

);
$this->footScript()->appendScript($script);
?>
<div id="js-order" class="clearfix order-checkout">
    <div class="page-header">
        <h1><?php _e('Checkout'); ?></h1>
    </div>
    <div class="row clearfix">
        <?php if ($cart['type_payment'] == 'installment') { ?>
            <div class="col-md-12">
                <div class="alert alert-info" role="alert">
                    <h2><?php _e('Terms of payment'); ?></h2>
                    <p><?php echo sprintf(__('You buy products on %s installment by %s payment on each installment and %s per payment'), _number(count($plan) - 2), Pi::api('api', 'order')->viewPrice($this->escape($plan[1]['price'])), Pi::api('api', 'order')->viewPrice($this->escape($plan[0]['price']))); ?></p>
                </div>
            </div>
        <?php } ?>
        <?php if (isset($cart['can_pay']) && $cart['can_pay'] == 2) { ?>
            <div class="col-md-12">
                <div class="alert alert-danger" role="alert">
                    <p><?php echo __('One of your select products or services have variable stock, than your payment option is disable, we will review your order and if your selected products or services be in stock we active payment option and send notification for you'); ?></p>
                </div>
            </div>
        <?php } ?>
    </div>
    <div class="clearfix row">
        <div class="col-md-8">
            <?php if (isset($formLogin) && !empty($formLogin)) { ?>
                <div class="alert alert-info" role="alert">
                    <?php _e('If you registered on website before this time and have user account, please login to system and continue ordering, and if you dont have user account here, please fill register new user account and make order form'); ?>
                </div>
                <div class="page-header">
                    <h3><?php _e('Login'); ?></h3>
                </div>
                <?php echo $this->form($formLogin); ?>
                <div class="page-header">
                    <h3><?php _e('Register new user account and make order'); ?></h3>
                </div>
            <?php } ?>
            <div class="clearfix alert alert-info" role="alert">
                <?php if (!empty($customers)) { ?>
                    <h4><?php _e('Select the needed address for your order. You can also add a new address') ?></h4>
                <?php } else { ?>
                    <h4><?php _e('You don\'t have set an address yet. Please create your adress we will use for your order. You will be able then to manage several adresses') ?></h4>
                <?php } ?>
            </div>
            <?php if (!empty($customers)) { ?>
                <div class="clearfix row">
                    <?php foreach ($customers as $customer) { ?>
                        <div class="col-md-4 customer-single"
                             data-id="customerFrom<?php echo $customer['id']; ?>"
                             data-button="customerFromButton<?php echo $customer['id']; ?>">
                             <div class="clearfix">
                                <div class="info">
                                    <p>
                                        <strong><?php _e('Invoicing address'); ?></strong>
                                    </p>
                                    <div>
                                        <?php echo $this->escape($customer['first_name']); ?>  <?php echo $this->escape($customer['last_name']); ?>
                                        ( <?php echo $this->escape($customer['email']); ?> )
                                    </div>
                                    <?php if (!empty($customer['company'])) { ?>
                                        <div><?php echo $this->escape($customer['company']); ?></div>
                                    <?php } ?>
                                    <?php if (!empty($customer['company_id'])) { ?>
                                        <div><?php echo $this->escape($customer['company_id']); ?></div>
                                    <?php } ?>
                                    <?php if (!empty($customer['company_vat'])) { ?>
                                        <div><?php echo $this->escape($customer['company_vat']); ?></div>
                                    <?php } ?>
                                    <?php if (!empty($customer['address1'])) { ?>
                                        <div><?php echo $this->escape($customer['address1']); ?></div>
                                    <?php } ?>
                                    <?php if (!empty($customer['address2'])) { ?>
                                        <div><?php echo $this->escape($customer['address2']); ?></div>
                                    <?php } ?>
                                    <div>
                                        <?php if (!empty($customer['zip_code'])) { ?>
                                            <?php echo $this->escape($customer['zip_code']); ?>&nbsp;
                                        <?php } ?>
                                        <?php if (!empty($customer['state'])) { ?>
                                            <?php echo $this->escape($customer['state']); ?>&nbsp;
                                        <?php } ?>
                                        <?php if (!empty($customer['city'])) { ?>
                                            <?php echo $this->escape($customer['city']); ?>&nbsp;
                                        <?php } ?>
                                        <?php if (!empty($customer['country'])) { ?>
                                            <?php echo $this->escape($customer['country']); ?>&nbsp;
                                        <?php } ?>
                                    </div>
                                    
                                    <?php if (!empty($customer['phone'])) { ?>
                                        <div>
                                            <?php _e('Phone'); ?> :
                                            <?php echo $this->escape($customer['phone']); ?>
                                        </div>
                                    <?php } ?>
                                    <?php if (!empty($customer['mobile'])) { ?>
                                        <div>
                                            <?php _e('Mobile'); ?> :
                                            <?php echo $this->escape($customer['mobile']); ?>
                                        </div>
                                    <?php } ?>
                                    
                                    <br />
                                </div>
                            
                                <ul class="list-inline">
                                    <li>
                                        <div class="label label-success hidden selected-address">
                                            <i class="fa fa-check"></i> <?php _e('Selected address') ?>
                                        </div>
                                    </li>
                                    <li>
                                        <a href="#" id="customerFromButton<?php echo $customer['id']; ?>" class="showCustomerFrom btn btn-success btn-sm" rel="<?php echo $customer['id']; ?>">
                                           <?php _e('Use it'); ?>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="<?php echo Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'index', 'customer' => $customer['id']))) ?>" class=" btn btn-primary  btn-sm" rel="<?php echo $customer['id']; ?>">
                                            <i class="fa fa-edit"></i> <?php _e('Edit'); ?>
                                        </a>
                                    </li>
                                    <li>
                                        <a href="<?php echo Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'delete', 'customer' => $customer['id']))) ?>" class=" btn btn-delete btn-sm" rel="<?php echo $customer['id']; ?>" onclick="return confirm('<?php _e('Are you sure you want delete this address?'); ?>');">
                                            <i class="fa fa-trash"></i> <?php _e('Delete'); ?>
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    <?php } ?>
                </div>
                <div class="alert clearfix" data-id="customerFromNew" data-button="customerFromButtonNew">
                    <div>
                        <div class="col-md-12">
                            <p>
                                <button id="customerFromButtonNew" class="btn btn-simple btn-sm">
                                    <?php _e('Add new address'); ?>
                                </button>
                            </p>
                        </div>
                    </div>
                    <div id="customerFromNew" class="col-md-6 clearfix <?php if (!$check) { echo 'hidden'; } ?>">
                        <?php echo $this->form($forms['new'], 'vertical'); ?>
                    </div>
                </div>
            <?php } else { ?>
                <div class="clearfix">
                    <?php echo $this->form($forms['new']); ?>
                </div>
            <?php } ?>
        </div>
        <div class="col-md-4">
            <div class="cart-product">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <h3 class="panel-title"><?php _e('Your order'); ?></h3>
                    </div>
                    <div class="clearfix">
                        <table class="cart-product-list">
                            <tr>
                                <th class="col-md-10"><?php _e('Product name') ?></th>
                                <th class="col-md-2 text-right"><?php _e('Total') ?></th>
                            </tr>
                            <?php $totalDiscount = 0 ?>
                            <?php foreach ($cart['product'] as $key => $product) { ?>
                                <?php 
                                    $extra = json_decode($product['extra'], true);
                                    $unconsumedPrice = $extra['unconsumedPrice']; 
                                ?>

                                <tr>
                                    <td>
                                        <a href="<?php echo $this->escape($product['details']['productUrl']); ?>"
                                           target="_blank">
                                            <b>#<?php echo ($key + 1) . ' ' . $this->escape($product['details']['title']); ?></b>
                                        </a>
                                        <?php if (!empty($extra['time_start'])) { ?>
                                            <p>
                                                <?php echo __('From') . ' ' . _date($extra['time_start']) . ' ' . __('to') . ' ' . _date($extra['time_end']) ?>
                                            </p>
                                        <?php } ?>
                                        <?php if (!empty($product['details']['thumbUrl'])) { ?>
                                            <div class="col-xs-5">
                                                <a href="<?php echo $this->escape($product['details']['productUrl']); ?>"
                                                   target="_blank">
                                                    <img class="img-responsive"
                                                         src="<?php echo $this->escape($product['details']['thumbUrl']); ?>">
                                                </a>
                                            </div>
                                        <?php } ?>
                                    </td>
                                    <td class="text-right">
                                        <strong><?php echo  Pi::api('api', 'order')->viewPrice($this->escape($product['product_price'] - $product['discount_price'] - $unconsumedPrice)); ?></strong>
                                    </td>
                                </tr>
                                <tr>
                                    <td><?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Price ext VAT'); ?></td>
                                    <td class="data-total-price"">
                                        <?php echo Pi::api('api', 'order')->viewPrice($this->escape($product['product_price'])); ?>
                                    </td>
                                </tr>
                                <?php if (isset($product['discount']) && $product['discount'] > 0) { ?>
                                    <tr>
                                        <td>
                                            <?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Total Discount'); ?>
                                            <?php if (isset($product['discount'])) { ?>
                                                (<span data-discount-for="<?php echo $product['product'] ?>"><?php echo $product['discount'] ?></span>%)
                                            <?php } ?>
                                        </td>
                                        <td data-discount-price-for="<?php echo $product['product'] ?>">
                                            <?php
                                                echo $product['discount_price'] > 0 ? '-' : ''; 
                                                echo Pi::api('api', 'order')->viewPrice($this->escape($product['discount_price'])); ?>
                                        </td>
                                    </tr>
                                <?php } ?>
                                <?php if ($unconsumedPrice) { ?>
                                    <tr>
                                        <td>
                                            <?php echo "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;" . __('Old package recovery'); ?>
                                        </td>
                                        <td data-discount-price-for="<?php echo $product['product'] ?>">
                                            <?php
                                                echo $unconsumedPrice > 0 ? '-' : ''; 
                                                echo Pi::api('api', 'order')->viewPrice($this->escape($unconsumedPrice)); 
                                            ?>
                                        </td>
                                    </tr>
                                <?php } ?> 
                                <?php $totalDiscount += $product['discount_price']; ?>
                                <?php $totalDiscount += $unconsumedPrice; ?>
                            <?php } ?>
                            <tr class="footer">

                                <td>
                                    <strong>
                                        <?php _e('Total Price ext VAT'); ?>
                                    </strong>
                                </td>
                                <td class="text-right data-total-price"">
                                    <strong><?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['product'] - $totalDiscount)); ?></strong>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <strong>
                                        <?php _e('Total Vat'); ?>
                                        <?php if (isset($product['vat'])) { ?>
                                            (<?php echo $product['vat'] ?>%)
                                        <?php } ?>
                                    </strong>
                                </td>
                                <td class="text-right test data-total-vat">
                                    <strong><?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['vat'])); ?></strong>
                                </td>
                            </tr>
                            <?php if ($price['shipping'] > 0) { ?>
                                <tr>
                                    <td><?php _e('Total Shipping'); ?></td>
                                    <td class="text-right">
                                        <?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['shipping'])); ?>
                                    </td>
                                </tr>
                            <?php } ?>
                            <?php if ($cart['type_payment'] != 'installment') { ?>
                                <tr class="panel-footer footer">
                                    <td>
                                        <strong>
                                            <?php _e('Final Price incl. VAT'); ?>
                                        </strong>
                                    </td>
                                    <td class="text-right">
                                        <spam class="label label-success data-total-price-ttc">
                                            <?php echo Pi::api('api', 'order')->viewPrice($this->escape($price['total'])); ?>
                                        </spam>
                                    </td>
                                </tr>
                            <?php } ?>
                        </table>
                    </div>
                </div>
                <div class="clearfix">
                    <?php if (isset($forms['promoCheckout'])) { ?>
                        <?php echo $this->form()->openTag($forms['promoCheckout']); ?>
                            <div class="col-md-4 nopadding">
                                <div class="form-group has-feedback" data-name="code">
                                    <label class=" control-label">
                                        <?php _e('Your promo code') ?>
                                    </label>
                                    <div class=" js-form-element">
                                        <?php echo $this->formElement($forms['promoCheckout']->get('code')); ?>
                                        <span class="glyphicon form-control-feedback" aria-hidden="true"></span>
                                        <span style="display:block;" class="text-muted"></span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-2 nopadding">
                                <label class=" control-label">
                                    &nbsp;
                                 </label>
                                <div class="form-group has-feedback" data-name="code">
                                    <div class=" js-form-element">
                                        <?php echo $this->formElement($forms['promoCheckout']->get('submit_promo')); ?>
                                    </div>
                                </div>
                            </div>
                            <div class="clearfix"></div>
                        <?php echo $this->form()->closeTag($forms['promoCheckout']); ?>
                        <?php if ($msgPromoCode) { ?>
                            <div class="clearfix alert alert-<?php echo $msgPromoCode['type'] ?>" role="alert">
                                    <span><?php echo $msgPromoCode['message'] ?></span>
                            </div>
                        <?php } ?>
                        
                        <div class="clearfix alert hidden" role="alert">
                            <span></span>
                        </div>
                            
                    <?php } ?>
                    <?php if (isset($forms['order'])) { ?>
                        <?php echo $this->form($forms['order'], 'vertical'); ?>
                    <?php } ?>
                    </table>
                    <?php if ($totalDiscount) { ?>
                        <div class="text-loyalty">
                            <?php _e('You can benefit from a discount loyalty price for this package. The system did apply it on the final price for you.'); ?>
                        </div>
                    <?php } ?>
                </div>
                <?php if (!empty($config['text_description_checkup'])) { ?>
                    <div class="checkout-description">
                        <?php echo $config['text_description_checkup']; ?>
                    </div>
                <?php } ?>
            </div>
        </div>
    </div>
</div>
<script>
    $( document ).ready(function() {
        $('#promoCheckout').on('submit', function() {
            var code = $('#promoCheckout input[name=code]').val();
            if (code == null) {
                return false;
            }
            $('#promoCheckout input[name=code]').val('');
        
            $.ajax({
              type: "POST",
              url: "<?php echo Pi::url($this->url('', array('controller' => 'checkout', 'action' => 'promocode'))) ?>",
              data: {code: code},
              success: function(data) {
                  $('#promoCheckout').parent().find('.alert')
                  .removeClass('hidden')
                  .removeClass('alert-info')
                  .removeClass('alert-success')
                  .addClass('alert-' + data.msgPromoCode.type);
                  
                  $('#promoCheckout').parent().find('.alert span').html(data.msgPromoCode.message);
                  
                  var totalDiscount = 0;
                  $.each(data.cart.product, 
                      function(i, product)
                      {
                          $('.cart-product span[data-discount-for=' + product.product + ']').html(product.discount);
                          $('.cart-product td[data-discount-price-for=' + product.product + ']').html(product.discount_price_view);
                      }
                  );
                  $('.cart-product .data-total-price').html(data.price.total_price_view);
                  $('.cart-product .data-total-vat').html(data.price.vat_view);
                  $('.cart-product .data-total-price-ttc').html(data.price.total_price_ttc_view);       
                  //$('[data-total-vat-for=445]').val()
              },
              dataType: 'json'
            });
            return false; 
        });
    });
</script>
